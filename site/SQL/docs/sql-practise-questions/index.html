
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Data Engineering 101 - concepts, quick reads, notes, etc.">
      
      
        <meta name="author" content="Kushal Luthra">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.16">
    
    
      
        <title>SQL Practise Questions - Data Engineering 101</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Data Engineering 101" class="md-header__button md-logo" aria-label="Data Engineering 101" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Engineering 101
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SQL Practise Questions
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kushal-luthra/data-engineering-101" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    data-engineering-101
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Data Engineering 101" class="md-nav__button md-logo" aria-label="Data Engineering 101" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Data Engineering 101
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kushal-luthra/data-engineering-101" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    data-engineering-101
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          SQL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="SQL" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          SQL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sql_performance_tuning/" class="md-nav__link">
        SQL Performance Tuning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sql_performance_tuning_summary/" class="md-nav__link">
        SQL Performance Tuning Summary
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sql-analytical-functions/" class="md-nav__link">
        SQL Analytical Functions
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        SQL Practise Questions
      </a>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Concepts" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Data-Warehousing-basics/" class="md-nav__link">
        Data Warehousing Concepts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Productivity Hacks
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Productivity Hacks" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Productivity Hacks
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../random/cold_mails/" class="md-nav__link">
        Cold Mail Tactics
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../aboutme/" class="md-nav__link">
        About Me
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/kushal-luthra/data-engineering-101/edit/main/docs/SQL/docs/sql-practise-questions.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>SQL Practise Questions</h1>

<p>Leetcode SQL</p>
<ol>
<li>The Most Recent Three Orders
Table: Customers</li>
</ol>
<pre><code>+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| customer_id   | int     |
| name          | varchar |
+---------------+---------+
customer_id is the primary key for this table.
This table contains information about customers.


Table: Orders
+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| order_id      | int     |
| order_date    | date    |
| customer_id   | int     |
| cost          | int     |
+---------------+---------+
order_id is the primary key for this table.
This table contains information about the orders made customer_id.
Each customer has one order per day.
</code></pre>
<p>Write an SQL query to find the most recent 3 orders of each user. <br>
If a user ordered less than 3 orders return all of their orders.<br>
Return the result table sorted by customer_name in ascending order and in case of a tie by the customer_id in ascending order. <br>
If there still a tie, order them by the order_date in descending order.<br>
The query result format is in the following example:<br></p>
<pre><code>Customers
+-------------+-----------+
| customer_id | name      |
+-------------+-----------+
| 1           | Winston   |
| 2           | Jonathan  |
| 3           | Annabelle |
| 4           | Marwan    |
| 5           | Khaled    |
+-------------+-----------+

Orders
+----------+------------+-------------+------+
| order_id | order_date | customer_id | cost |
+----------+------------+-------------+------+
| 1        | 2020-07-31 | 1           | 30   |
| 2        | 2020-07-30 | 2           | 40   |
| 3        | 2020-07-31 | 3           | 70   |
| 4        | 2020-07-29 | 4           | 100  |
| 5        | 2020-06-10 | 1           | 1010 |
| 6        | 2020-08-01 | 2           | 102  |
| 7        | 2020-08-01 | 3           | 111  |
| 8        | 2020-08-03 | 1           | 99   |
| 9        | 2020-08-07 | 2           | 32   |
| 10       | 2020-07-15 | 1           | 2    |
+----------+------------+-------------+------+

Result table:
+---------------+-------------+----------+------------+
| customer_name | customer_id | order_id | order_date |
+---------------+-------------+----------+------------+
| Annabelle     | 3           | 7        | 2020-08-01 |
| Annabelle     | 3           | 3        | 2020-07-31 |
| Jonathan      | 2           | 9        | 2020-08-07 |
| Jonathan      | 2           | 6        | 2020-08-01 |
| Jonathan      | 2           | 2        | 2020-07-30 |
| Marwan        | 4           | 4        | 2020-07-29 |
| Winston       | 1           | 8        | 2020-08-03 |
| Winston       | 1           | 1        | 2020-07-31 |
| Winston       | 1           | 10       | 2020-07-15 |
+---------------+-------------+----------+------------+
Winston has 4 orders, we discard the order of &quot;2020-06-10&quot; because it is the oldest order.
Annabelle has only 2 orders, we return them.
Jonathan has exactly 3 orders.
Marwan ordered only one time.
We sort the result table by customer_name in ascending order, by customer_id in ascending order and by order_date in descending order in case of a tie.
</code></pre>
<p>Ans.</p>
<pre><code>select 
customer_name, 
customer_id, 
order_id, 
order_date  

from 
(select
    a.name as customer_name,
    a.customer_id,
    b.order_id,
    to_char(b.order_date, 'YYYY-MM-DD') as order_date,
    rank() over ( partition by a.customer_id order by b.order_date desc)   date_rank
    from 
    customers a inner join orders b 
    on a.customer_id = b.customer_id 
    order by a.customer_id, b.order_date  
)
where date_rank&lt;=3
order by customer_name, customer_id, order_date desc
;
</code></pre>
<p>2A. Shortest Distance in a Plane<br>
https://leetcode.com/problems/shortest-distance-in-a-plane/ <br>
Table point_2d holds the coordinates (x,y) of some unique points (more than two) in a plane.<br>
Write a query to find the shortest distance between these points rounded to 2 decimals.<br></p>
<table>
<thead>
<tr>
<th>x</th>
<th>y</th>
</tr>
</thead>
<tbody>
<tr>
<td>-1</td>
<td>-1</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>-1</td>
<td>-2</td>
</tr>
</tbody>
</table>
<p>The shortest distance is 1.00 from point (-1,-1) to (-1,2). So the output should be:</p>
<table>
<thead>
<tr>
<th>shortest</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.00</td>
</tr>
</tbody>
</table>
<p>Note: The longest distance among all the points are less than 10000.<br></p>
<p>Ans.<br></p>
<pre><code>select min(dist) as shortest from 
    (
    select
         a.x as x1,
         a.y as y1,
         b.x as x2,
         b.y as y2,
        round(sqrt((a.x - b.x)*(a.x - b.x) + (a.y - b.y)*(a.y - b.y) ),2) as dist
    from point_2d a, point_2d b 
    where concat(a.x,a.y)!=concat(b.x,b.y) -- this bit of matching coordinates is IMP to ensure same coordinates are not being captured.
    );
</code></pre>
<ol>
<li>Investments in 2016 <br>
https://leetcode.com/problems/investments-in-2016/ <br></li>
</ol>
<p>Write a query to print the sum of all total investment values in 2016 (TIV_2016), to a scale of 2 decimal places, for all policy-holders who meet the following criteria:<br>
- Have the same TIV_2015 value as one or more other policyholders.<br>
- Are not located in the same city as any other policyholder (i.e.: the (latitude, longitude) attribute pairs must be unique).<br></p>
<p>Input Format:<br></p>
<p>The insurance table is described as follows:<br></p>
<table>
<thead>
<tr>
<th>Column Name</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>PID</td>
<td>INTEGER(11)</td>
</tr>
<tr>
<td>TIV_2015</td>
<td>NUMERIC(15,2)</td>
</tr>
<tr>
<td>TIV_2016</td>
<td>NUMERIC(15,2)</td>
</tr>
<tr>
<td>LAT</td>
<td>NUMERIC(5,2)</td>
</tr>
<tr>
<td>LON</td>
<td>NUMERIC(5,2)</td>
</tr>
<tr>
<td>where PID is the policyholder's policy ID, TIV_2015 is the total investment value in 2015, TIV_2016 is the total investment value in 2016, LAT is the latitude of the policy holder's city, and LON is the longitude of the policy holder's city.<br></td>
<td></td>
</tr>
</tbody>
</table>
<p>Sample Input<br></p>
<table>
<thead>
<tr>
<th>PID</th>
<th>TIV_2015</th>
<th>TIV_2016</th>
<th>LAT</th>
<th>LON</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>10</td>
<td>5</td>
<td>10</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>20</td>
<td>20</td>
<td>20</td>
<td>20</td>
</tr>
<tr>
<td>3</td>
<td>10</td>
<td>30</td>
<td>20</td>
<td>20</td>
</tr>
<tr>
<td>4</td>
<td>10</td>
<td>40</td>
<td>40</td>
<td>40</td>
</tr>
</tbody>
</table>
<p>Sample Output<br></p>
<p>| TIV_2016 |
|----------|
| 45.00    |
Explanation</p>
<p>The first record in the table, like the last record, meets both of the two criteria.<br>
The TIV_2015 value '10' is as the same as the third and forth record, and its location unique.<br></p>
<p>The second record does not meet any of the two criteria. Its TIV_2015 is not like any other policyholders.<br></p>
<p>And its location is the same with the third record, which makes the third record fail, too.<br></p>
<p>So, the result is the sum of TIV_2016 of the first and last record, which is 45.<br></p>
<p>Ans.<br></p>
<pre><code>select round(sum(tiv_2016),2) as &quot;TIV_2016&quot; from (
select
    pid,
    count(pid) over (partition by tiv_2015) as tiv_2015_count,
    tiv_2016,
    count(*) over (partition by concat(concat(lat,'_'),lon)) as locn_count
from
    insurance order by lat,lon) where locn_count=1 and tiv_2015_count&gt;1;
</code></pre>
<ol>
<li>Calculate Salaries <br>
https://leetcode.com/problems/calculate-salaries/ <br></li>
</ol>
<p>Table Salaries:<br></p>
<table>
<thead>
<tr>
<th>Column Name</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>company_id</td>
<td>int</td>
</tr>
<tr>
<td>employee_id</td>
<td>int</td>
</tr>
<tr>
<td>employee_name</td>
<td>varchar</td>
</tr>
<tr>
<td>salary</td>
<td>int</td>
</tr>
</tbody>
</table>
<p>(company_id, employee_id) is the primary key for this table.<br>
This table contains the company id, the id, the name and the salary for an employee.<br></p>
<p>Write an SQL query to find the salaries of the employees after applying taxes.<br></p>
<p>The tax rate is calculated for each company based on the following criteria:<br></p>
<p>0% If the max salary of any employee in the company is less than 1000$.<br>
24% If the max salary of any employee in the company is in the range [1000, 10000] inclusive.<br>
49% If the max salary of any employee in the company is greater than 10000$.<br>
Return the result table in any order. Round the salary to the nearest integer.<br></p>
<p>The query result format is in the following example:<br></p>
<pre><code>Salaries table:
+------------+-------------+---------------+--------+
| company_id | employee_id | employee_name | salary |
+------------+-------------+---------------+--------+
| 1          | 1           | Tony          | 2000   |
| 1          | 2           | Pronub        | 21300  |
| 1          | 3           | Tyrrox        | 10800  |
| 2          | 1           | Pam           | 300    |
| 2          | 7           | Bassem        | 450    |
| 2          | 9           | Hermione      | 700    |
| 3          | 7           | Bocaben       | 100    |
| 3          | 2           | Ognjen        | 2200   |
| 3          | 13          | Nyancat       | 3300   |
| 3          | 15          | Morninngcat   | 1866   |
+------------+-------------+---------------+--------+

Result table:
+------------+-------------+---------------+--------+
| company_id | employee_id | employee_name | salary |
+------------+-------------+---------------+--------+
| 1          | 1           | Tony          | 1020   |
| 1          | 2           | Pronub        | 10863  |
| 1          | 3           | Tyrrox        | 5508   |
| 2          | 1           | Pam           | 300    |
| 2          | 7           | Bassem        | 450    |
| 2          | 9           | Hermione      | 700    |
| 3          | 7           | Bocaben       | 76     |
| 3          | 2           | Ognjen        | 1672   |
| 3          | 13          | Nyancat       | 2508   |
| 3          | 15          | Morninngcat   | 5911   |
+------------+-------------+---------------+--------+
For company 1, Max salary is 21300. Employees in company 1 have taxes = 49%
For company 2, Max salary is 700. Employees in company 2 have taxes = 0%
For company 3, Max salary is 7777. Employees in company 3 have taxes = 24%
The salary after taxes = salary - (taxes percentage / 100) * salary
For example, Salary for Morninngcat (3, 15) after taxes = 7777 - 7777 * (24 / 100) = 7777 - 1866.48 = 5910.52, which is rounded to 5911.
</code></pre>
<p>Ans.</p>
<pre><code>select 
company_id,
employee_id,
employee_name,
round(
    salary*(case 
        when max_sal_per_company&lt;1000 then 1 
        when max_sal_per_company&gt;=1000 and max_sal_per_company&lt;=10000 then 0.76
        else 0.51 
        end
        ),0) as salary
from
(
select 
 company_id , employee_id , employee_name , salary, 
 max(salary) over (partition by company_id ) as max_sal_per_company
 from salaries);

 ```

 5. Countries You Can Safely Invest In&lt;br&gt;
 https://leetcode.com/problems/countries-you-can-safely-invest-in/ &lt;br&gt;

 Table Person:

| Column Name    | Type    |
|----------------|---------|
| id             | int     |
| name           | varchar |
| phone_number   | varchar |

id is the primary key for this table.&lt;br&gt;
Each row of this table contains the name of a person and their phone number.&lt;br&gt;
Phone number will be in the form 'xxx-yyyyyyy' where xxx is the country code (3 characters) and yyyyyyy is the phone number (7 characters) where x and y are digits. &lt;br&gt;
Both can contain leading zeros.&lt;br&gt;

Table Country:

| Column Name    | Type    |
|----------------|---------|
| name           | varchar |
| country_code   | varchar |

country_code is the primary key for this table.&lt;br&gt;
Each row of this table contains the country name and its code. country_code will be in the form 'xxx' where x is digits.&lt;br&gt;


Table Calls:&lt;br&gt;

| Column Name | Type |
|-------------|------|
| caller_id   | int  |
| callee_id   | int  |
| duration    | int  |



There is no primary key for this table, it may contain duplicates.&lt;br&gt;
Each row of this table contains the caller id, callee id and the duration of the call in minutes. caller_id != callee_id&lt;br&gt;
A telecommunications company wants to invest in new countries. The company intends to invest in the countries where the average call duration of the calls in this country is strictly greater than the global average call duration.&lt;br&gt;

Write an SQL query to find the countries where this company can invest.&lt;br&gt;

Return the result table in any order.&lt;br&gt;

The query result format is in the following example.&lt;br&gt;
</code></pre>
<p>Person table:
+----+----------+--------------+
| id | name     | phone_number |
+----+----------+--------------+
| 3  | Jonathan | 051-1234567  |
| 12 | Elvis    | 051-7654321  |
| 1  | Moncef   | 212-1234567  |
| 2  | Maroua   | 212-6523651  |
| 7  | Meir     | 972-1234567  |
| 9  | Rachel   | 972-0011100  |
+----+----------+--------------+</p>
<p>Country table:
+----------+--------------+
| name     | country_code |
+----------+--------------+
| Peru     | 051          |
| Israel   | 972          |
| Morocco  | 212          |
| Germany  | 049          |
| Ethiopia | 251          |
+----------+--------------+</p>
<p>Calls table:
+-----------+-----------+----------+
| caller_id | callee_id | duration |
+-----------+-----------+----------+
| 1         | 9         | 33       |
| 2         | 9         | 4        |
| 1         | 2         | 59       |
| 3         | 12        | 102      |
| 3         | 12        | 330      |
| 12        | 3         | 5        |
| 7         | 9         | 13       |
| 7         | 1         | 3        |
| 9         | 7         | 1        |
| 1         | 7         | 7        |
+-----------+-----------+----------+</p>
<p>Result table:
+----------+
| country  |
+----------+
| Peru     |
+----------+
The average call duration for Peru is (102 + 102 + 330 + 330 + 5 + 5) / 6 = 145.666667
The average call duration for Israel is (33 + 4 + 13 + 13 + 3 + 1 + 1 + 7) / 8 = 9.37500
The average call duration for Morocco is (33 + 4 + 59 + 59 + 3 + 7) / 6 = 27.5000 
Global call duration average = (2 * (33 + 3 + 59 + 102 + 330 + 5 + 13 + 3 + 1 + 7)) / 20 = 55.70000
Since Peru is the only country where average call duration is greater than the global average, it's the only recommended country.</p>
<pre><code>Ans.
</code></pre>
<p>with call_table as (select 
    distinct
        caller_id, 
        callee_id,
        duration
from
calls
)
select distinct country from (
                                select 
                                t.name as country,
                                c.country_code,
                                avg(c.duration) over (partition by c.country_code) as country_avg,
                                avg(c.duration) over () as overall_avg
                                from (
                                            select 
                                                substr(b.phone_number,1,3) as country_code,
                                                a.duration 
                                                from 
                                                    call_table a 
                                                left join 
                                                    Person b 
                                                on a.caller_id = b.id 
                                            union all
                                            select 
                                                substr(b.phone_number,1,3) as country_code,
                                                a.duration 
                                                from 
                                                    call_table a 
                                                left join 
                                                    Person b 
                                                on a.callee_id = b.id
                                    ) c
                                      left join Country t
                                      on trim(c.country_code) = trim(t.country_code)
                                ) 
                                where country_avg&gt;overall_avg;</p>
<pre><code>
5. Rectangles Area&lt;br&gt;
https://leetcode.com/problems/rectangles-area/ &lt;br&gt;
Table: Points&lt;br&gt;

+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| id            | int     |
| x_value       | int     |
| y_value       | int     |
+---------------+---------+
id is the primary key for this table.&lt;br&gt;
Each point is represented as a 2D Dimensional (x_value, y_value).&lt;br&gt;
Write an SQL query to report of all possible rectangles which can be formed by any two points of the table.&lt;br&gt; 

Each row in the result contains three columns (p1, p2, area) where:&lt;br&gt;

p1 and p2 are the id of two opposite corners of a rectangle and p1 &lt; p2.&lt;br&gt;
Area of this rectangle is represented by the column area.&lt;br&gt;
Report the query in descending order by area in case of tie in ascending order by p1 and p2.&lt;br&gt;

</code></pre>
<p>Points table:
+----------+-------------+-------------+
| id       | x_value     | y_value     |
+----------+-------------+-------------+
| 1        | 2           | 8           |
| 2        | 4           | 7           |
| 3        | 2           | 10          |
+----------+-------------+-------------+</p>
<p>Result table:
+----------+-------------+-------------+
| p1       | p2          | area        |
+----------+-------------+-------------+
| 2        | 3           | 6           |
| 1        | 2           | 2           |
+----------+-------------+-------------+</p>
<p>p1 should be less than p2 and area greater than 0.
p1 = 1 and p2 = 2, has an area equal to |2-4| * |8-7| = 2.
p1 = 2 and p2 = 3, has an area equal to |4-2| * |7-10| = 6.
p1 = 1 and p2 = 3 It's not possible because the rectangle has an area equal to 0.</p>
<pre><code>
Ans.

</code></pre>
<p>-- Approach 1:
select 
    a.id as P1,
    b.id as P2,
    abs(a.x_value - b.x_value)<em>abs(a.y_value - b.y_value) as area
from
    points a, points b
where <br />
    a.id &lt; b.id   and 
    abs(a.x_value - b.x_value)</em>abs(a.y_value - b.y_value)&gt;0
order by 
        abs(a.x_value - b.x_value)<em>abs(a.y_value - b.y_value) desc, 
        a.id, 
        b.id; 
-- Approach 2:
select   <br />
    a.p1, b.p2, 
    abs(a.x1-b.x2)</em>abs(a.y1-b.y2) as area
from   <br />
(select 
    id as P1,
    x_value as x1,
    y_value as y1,
    concat(x_value, y_value) as p1_coordinate
from points) a, 
(select 
    id as P2,
     x_value as x2,
    y_value as y2,
    concat(x_value, y_value) as p2_coordinate
from points    ) b
where 
    p1<p2
    and
    p1_coordinate!=p2_coordinate --no duplicate/same point
    and 
    abs(x1-x2)*abs(y1-y2)>0
order by abs(a.x1-b.x2)*abs(a.y1-b.y2) desc, a.p1, b.p2     </p>
<pre><code>
6. Active users : Imp -- date diff between consecutive days. &lt;br&gt;
https://leetcode.com/problems/active-users/      &lt;br&gt;

Table Accounts: &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| id            | int     |
| name          | varchar |

the id is the primary key for this table. &lt;br&gt;
This table contains the account id and the user name of each account. &lt;br&gt;


Table Logins: &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| id            | int     |
| login_date    | date    |
+---------------+---------+
There is no primary key for this table, it may contain duplicates. &lt;br&gt;
This table contains the account id of the user who logged in and the login date. A user may log in multiple times in the day. &lt;br&gt;


Write an SQL query to find the id and the name of active users. &lt;br&gt;

Active users are those who logged in to their accounts for 5 or more consecutive days. &lt;br&gt;

Return the result table ordered by the id. &lt;br&gt;

The query result format is in the following example: &lt;br&gt;

Accounts table:

| id | name     |
|----|----------|
| 1  | Winston  |
| 7  | Jonathan |

Logins table: &lt;br&gt;

| id | login_date |
|----|------------|
| 7  | 2020-05-30 |
| 1  | 2020-05-30 |
| 7  | 2020-05-31 |
| 7  | 2020-06-01 |
| 7  | 2020-06-02 |
| 7  | 2020-06-02 |
| 7  | 2020-06-03 |
| 1  | 2020-06-07 |
| 7  | 2020-06-10 |


Result table: &lt;br&gt;

| id | name     |
|----|----------|
| 7  | Jonathan |


User Winston with id = 1 logged in 2 times only in 2 different days, so, Winston is not an active user. &lt;br&gt;
User Jonathan with id = 7 logged in 7 times in 6 different days, five of them were consecutive days, so, Jonathan is an active user. &lt;br&gt;

Ans.

</code></pre>
<p>select distinct 
        d.id, 
        d.name 
    from 
        (
            select 
                b.id,
                c.name,
                b.login_date,
                b.found_recs_old_login_date,
                to_date(b.login_date,'YYYY-MM-DD') - to_date(b.found_recs_old_login_date,'YYYY-MM-DD') as date_diff
            from (
                 select 
                    a.id,
                    a.login_date,
                    lag( a.login_date,4,'1990-01-01') over (partition by a.id order by  a.login_date) as found_recs_old_login_date 
                 from 
                 (select distinct id, to_char(login_date,'YYYY-MM-DD') as login_date from Logins ) a<br />
                ) b
            left join 
                  Accounts c
            on b.id = c.id<br />
        ) d 
where d.date_diff=4 
order by d.id;</p>
<pre><code>

7.  Apples &amp; Oranges &lt;br&gt;
https://leetcode.com/problems/apples-oranges/ &lt;br&gt;

Table: Sales &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| sale_date     | date    |
| fruit         | enum    | 
| sold_num      | int     | 

(sale_date,fruit) is the primary key for this table. &lt;br&gt;
This table contains the sales of &quot;apples&quot; and &quot;oranges&quot; sold each day. &lt;br&gt;

Write an SQL query to report the difference between number of apples and oranges sold each day. &lt;br&gt;

Return the result table ordered by sale_date in format ('YYYY-MM-DD'). &lt;br&gt;

The query result format is in the following example: &lt;br&gt;

</code></pre>
<p>Sales table:
+------------+------------+-------------+
| sale_date  | fruit      | sold_num    |
+------------+------------+-------------+
| 2020-05-01 | apples     | 10          |
| 2020-05-01 | oranges    | 8           |
| 2020-05-02 | apples     | 15          |
| 2020-05-02 | oranges    | 15          |
| 2020-05-03 | apples     | 20          |
| 2020-05-03 | oranges    | 0           |
| 2020-05-04 | apples     | 15          |
| 2020-05-04 | oranges    | 16          |
+------------+------------+-------------+</p>
<p>Result table:
+------------+--------------+
| sale_date  | diff         |
+------------+--------------+
| 2020-05-01 | 2            |
| 2020-05-02 | 0            |
| 2020-05-03 | 20           |
| 2020-05-04 | -1           |
+------------+--------------+</p>
<p>Day 2020-05-01, 10 apples and 8 oranges were sold (Difference  10 - 8 = 2).
Day 2020-05-02, 15 apples and 15 oranges were sold (Difference 15 - 15 = 0).
Day 2020-05-03, 20 apples and 0 oranges were sold (Difference 20 - 0 = 20).
Day 2020-05-04, 15 apples and 16 oranges were sold (Difference 15 - 16 = -1).</p>
<pre><code>
Ans.

</code></pre>
<p>KL -
select
        coalesce(to_char(a.sale_date,'YYYY-MM-DD'),to_char(b.sale_date,'YYYY-MM-DD')) as sale_date,
        coalesce(a.sold_num,0) - coalesce(b.sold_num,0) as diff
from 
    (select sale_date , sold_num from sales where fruit='apples') a<br />
full join
    (select sale_date , sold_num from sales where fruit='oranges') b
on 
    to_char(a.sale_date,'YYYY-MM-DD')=to_char(b.sale_date,'YYYY-MM-DD')
order by 
    coalesce(to_char(a.sale_date,'YYYY-MM-DD'),to_char(b.sale_date,'YYYY-MM-DD'));</p>
<p>NG -
    select sale_date, 
           sum(case when fruit = 'apples' then sold_num else 0-sold_num end) as "diff"
    from sales
    group by sale_date</p>
<pre><code>
8. Evaluate Boolean Expression &lt;br&gt;
https://leetcode.com/problems/evaluate-boolean-expression/ &lt;br&gt;

Table Variables: &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| name          | varchar |
| value         | int     |

name is the primary key for this table. &lt;br&gt;
This table contains the stored variables and their values. &lt;br&gt;


Table Expressions: &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| left_operand  | varchar |
| operator      | enum    |
| right_operand | varchar |

(left_operand, operator, right_operand) is the primary key for this table. &lt;br&gt;
This table contains a boolean expression that should be evaluated. &lt;br&gt;
operator is an enum that takes one of the values ('&lt;', '&gt;', '=') &lt;br&gt;
The values of left_operand and right_operand are guaranteed to be in the Variables table. &lt;br&gt;

Write an SQL query to evaluate the boolean expressions in Expressions table. &lt;br&gt;

Return the result table in any order. &lt;br&gt;

The query result format is in the following example. &lt;br&gt;

</code></pre>
<p>Variables table:
+------+-------+
| name | value |
+------+-------+
| x    | 66    |
| y    | 77    |
+------+-------+</p>
<p>Expressions table:
+--------------+----------+---------------+
| left_operand | operator | right_operand |
+--------------+----------+---------------+
| x            | &gt;        | y             |
| x            | &lt;        | y             |
| x            | =        | y             |
| y            | &gt;        | x             |
| y            | &lt;        | x             |
| x            | =        | x             |
+--------------+----------+---------------+</p>
<p>Result table:
+--------------+----------+---------------+-------+
| left_operand | operator | right_operand | value |
+--------------+----------+---------------+-------+
| x            | &gt;        | y             | false |
| x            | &lt;        | y             | true  |
| x            | =        | y             | false |
| y            | &gt;        | x             | true  |
| y            | &lt;        | x             | false |
| x            | =        | x             | true  |
+--------------+----------+---------------+-------+
As shown, you need find the value of each boolean exprssion in the table using the variables table.</p>
<pre><code>
Ans.
</code></pre>
<p>select 
        left_operand as "left_operand",
        operator as "operator",
        right_operand as "right_operand",
        case 
            when operator='&gt;' then case when left_value&gt;right_value then 'true' else 'false' end 
            when operator='&lt;' then case when left_value&lt;right_value then 'true' else 'false' end 
            when operator='=' then case when left_value=right_value then 'true' else 'false' end 
        end as "value" 
        from 
            (
                select
                    a.left_operand  ,
                    b.value as left_value,
                    a.operator ,
                    a.right_operand ,
                    c.value as right_value
                from 
                    expressions a
                left join 
                    variables b
                on a.left_operand = b.name
                left join 
                    variables c
                on a.right_operand = c.name
            );</p>
<pre><code>
9. Customers Who Bought Products A and B but Not C  &lt;br&gt;
https://leetcode.com/problems/customers-who-bought-products-a-and-b-but-not-c/submissions/ &lt;br&gt;     

Table: Customers &lt;br&gt;

| Column Name         | Type    |
|---------------------|---------|
| customer_id         | int     |
| customer_name       | varchar |

customer_id is the primary key for this table. &lt;br&gt;
customer_name is the name of the customer. &lt;br&gt;

Table: Orders

| Column Name   | Type    |
|---------------|---------|
| order_id      | int     |
| customer_id   | int     |
| product_name  | varchar |

order_id is the primary key for this table. &lt;br&gt;
customer_id is the id of the customer who bought the product &quot;product_name&quot;. &lt;br&gt;

Write an SQL query to report the customer_id and customer_name of customers who bought products &quot;A&quot;, &quot;B&quot; but did not buy the product &quot;C&quot; since we want to recommend them buy this product. &lt;br&gt;

Return the result table ordered by customer_id. &lt;br&gt;

The query result format is in the following example. &lt;br&gt;

</code></pre>
<p>Customers table:
+-------------+---------------+
| customer_id | customer_name |
+-------------+---------------+
| 1           | Daniel        |
| 2           | Diana         |
| 3           | Elizabeth     |
| 4           | Jhon          |
+-------------+---------------+</p>
<p>Orders table:
+------------+--------------+---------------+
| order_id   | customer_id  | product_name  |
+------------+--------------+---------------+
| 10         |     1        |     A         |
| 20         |     1        |     B         |
| 30         |     1        |     D         |
| 40         |     1        |     C         |
| 50         |     2        |     A         |
| 60         |     3        |     A         |
| 70         |     3        |     B         |
| 80         |     3        |     D         |
| 90         |     4        |     C         |
+------------+--------------+---------------+</p>
<p>Result table:
+-------------+---------------+
| customer_id | customer_name |
+-------------+---------------+
| 3           | Elizabeth     |
+-------------+---------------+
Only the customer_id with id 3 bought the product A and B but not the product C.</p>
<pre><code>Ans. &lt;br&gt;

</code></pre>
<p>select 
    customer_id,
    customer_name
from (
        select 
            distinct<br />
                    a.customer_id,<br />
                    b.customer_name, 
                    a.product_name 
           from 
            orders a 
                left join    <br />
            customers b    <br />
            on a.customer_id = b.customer_id   <br />
        where a.product_name in ('A','B','C') 
    )
    group by customer_id,customer_name
    having sum(case when product_name='A' then 1 when product_name='B' then 2 else 100 end)=3
    order by customer_id;</p>
<pre><code>10.  Capital Gain/Loss &lt;br&gt;
https://leetcode.com/problems/capital-gainloss/ &lt;br&gt;

Table: Stocks &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| stock_name    | varchar |
| operation     | enum    |
| operation_day | int     |
| price         | int     |

(stock_name, day) is the primary key for this table. &lt;br&gt;
The operation column is an ENUM of type ('Sell', 'Buy') &lt;br&gt;
Each row of this table indicates that the stock which has stock_name had an operation on the day operation_day with the price. &lt;br&gt;
It is guaranteed that each 'Sell' operation for a stock has a corresponding 'Buy' operation in a previous day. &lt;br&gt;


Write an SQL query to report the Capital gain/loss for each stock. &lt;br&gt;

The capital gain/loss of a stock is total gain or loss after buying and selling the stock one or many times. &lt;br&gt;

Return the result table in any order. &lt;br&gt;

The query result format is in the following example: &lt;br&gt;
</code></pre>
<p>Stocks table:
+---------------+-----------+---------------+--------+
| stock_name    | operation | operation_day | price  |
+---------------+-----------+---------------+--------+
| Leetcode      | Buy       | 1             | 1000   |
| Corona Masks  | Buy       | 2             | 10     |
| Leetcode      | Sell      | 5             | 9000   |
| Handbags      | Buy       | 17            | 30000  |
| Corona Masks  | Sell      | 3             | 1010   |
| Corona Masks  | Buy       | 4             | 1000   |
| Corona Masks  | Sell      | 5             | 500    |
| Corona Masks  | Buy       | 6             | 1000   |
| Handbags      | Sell      | 29            | 7000   |
| Corona Masks  | Sell      | 10            | 10000  |
+---------------+-----------+---------------+--------+</p>
<p>Result table:
+---------------+-------------------+
| stock_name    | capital_gain_loss |
+---------------+-------------------+
| Corona Masks  | 9500              |
| Leetcode      | 8000              |
| Handbags      | -23000            |
+---------------+-------------------+</p>
<pre><code>Leetcode stock was bought at day 1 for 1000$ and was sold at day 5 for 9000$. Capital gain = 9000 - 1000 = 8000$. &lt;br&gt;
Handbags stock was bought at day 17 for 30000$ and was sold at day 29 for 7000$. Capital loss = 7000 - 30000 = -23000$. &lt;br&gt;
Corona Masks stock was bought at day 1 for 10$ and was sold at day 3 for 1010$. It was bought again at day 4 for 1000$ and was sold at day 5 for 500$.  &lt;br&gt;
At last, it was bought at day 6 for 1000$ and was sold at day 10 for 10000$.  &lt;br&gt;
Capital gain/loss is the sum of capital gains/losses for each ('Buy' --&gt; 'Sell') operation  &lt;br&gt;
= (1010 - 10) + (500 - 1000) + (10000 - 1000) = 1000 - 500 + 9000 = 9500$.

Ans.

</code></pre>
<p>select
    stock_name,
    sum(case when operation ='Sell' then price else 0-price end) as capital_gain_loss 
from 
    stocks
group by stock_name
order by stock_name;</p>
<pre><code>
12. Number of Trusted Contacts of a Customer &lt;br&gt;
https://leetcode.com/problems/number-of-trusted-contacts-of-a-customer/ &lt;br&gt;

Table: Customers &lt;br&gt;

| Column Name   | Type    |
|--------------|---------|
| customer_id   | int     |
| customer_name | varchar |
| email         | varchar |

customer_id is the primary key for this table. &lt;br&gt;
Each row of this table contains the name and the email of a customer of an online shop. &lt;br&gt;

Table: Contacts &lt;br&gt;

| Column Name   | Type    |
|--------------|---------|
| user_id       | id      |
| contact_name  | varchar |
| contact_email | varchar |

(user_id, contact_email) is the primary key for this table. &lt;br&gt;
Each row of this table contains the name and email of one contact of customer with user_id. &lt;br&gt;
This table contains information about people each customer trust. The contact may or may not exist in the Customers table. &lt;br&gt;

Table: Invoices &lt;br&gt;

| Column Name  | Type    |
|--------------|---------|
| invoice_id   | int     |
| price        | int     |
| user_id      | int     |


invoice_id is the primary key for this table. &lt;br&gt;
Each row of this table indicates that user_id has an invoice with invoice_id and a price. &lt;br&gt;

Write an SQL query to find the following for each invoice_id: &lt;br&gt;

customer_name: The name of the customer the invoice is related to. &lt;br&gt;
price: The price of the invoice. &lt;br&gt;
contacts_cnt: The number of contacts related to the customer. &lt;br&gt;
trusted_contacts_cnt: The number of contacts related to the customer and at the same time they are customers to the shop. &lt;br&gt; 
(i.e His/Her email exists in the Customers table.) &lt;br&gt;
Order the result table by invoice_id. &lt;br&gt;

The query result format is in the following example: &lt;br&gt;

Customers table: &lt;br&gt;

| customer_id | customer_name | email              |
|-------------|---------------|--------------------|
| 1           | Alice         | alice@leetcode.com |
| 2           | Bob           | bob@leetcode.com   |
| 13          | John          | john@leetcode.com  |
| 6           | Alex          | alex@leetcode.com  |


Contacts table:

| user_id     | contact_name | contact_email      |
|-------------|--------------|--------------------|
| 1           | Bob          | bob@leetcode.com   |
| 1           | John         | john@leetcode.com  |
| 1           | Jal          | jal@leetcode.com   |
| 2           | Omar         | omar@leetcode.com  |
| 2           | Meir         | meir@leetcode.com  |
| 6           | Alice        | alice@leetcode.com |



Invoices table:  &lt;br&gt;

| invoice_id | price | user_id |
|------------|-------|---------|
| 77         | 100   | 1       |
| 88         | 200   | 1       |
| 99         | 300   | 2       |
| 66         | 400   | 2       |
| 55         | 500   | 13      |
| 44         | 60    | 6       |


Result table:

| invoice_id | customer_name | price | contacts_cnt | trusted_contacts_cnt |
|------------|---------------|-------|--------------|----------------------|
| 44         | Alex          | 60    | 1            | 1                    |
| 55         | John          | 500   | 0            | 0                    |
| 66         | Bob           | 400   | 2            | 0                    |
| 77         | Alice         | 100   | 3            | 2                    |
| 88         | Alice         | 200   | 3            | 2                    |
| 99         | Bob           | 300   | 2            | 0                    |


Alice has three contacts, two of them are trusted contacts (Bob and John). &lt;br&gt;
Bob has two contacts, none of them is a trusted contact. &lt;br&gt;
Alex has one contact and it is a trusted contact (Alice). &lt;br&gt;
John doesn't have any contacts. &lt;br&gt;

Ans.
</code></pre>
<p>select
    a.invoice_id ,
    b.customer_name,
    a.price,
    (select count(<em>) from contacts where user_id =  a.user_id) as contacts_cnt ,
    (select count(</em>) from contacts where user_id = a.user_id and contact_email in (select email from customers) ) as trusted_contacts_cnt 
from
    invoices a
left join 
    customers b
on 
    a.user_id = b.customer_id
order by invoice_id;</p>
<p>-- Other Approach: Using Joins
select
        a.invoice_id ,
        b.customer_name,
        a.price,
        count(e.contact_email) as contacts_cnt  ,
        sum(case when e.email is not NULL then 1 else 0 end) as trusted_contacts_cnt 
from
        invoices a
left join 
        customers b
on 
        a.user_id = b.customer_id
left join 
(
    select 
        c.user_id,
        c.contact_email,
        d.email
        from contacts c left join 
            customers d 
        on c.contact_email = d.email
) e
on a.user_id = e.user_id
group by a.invoice_id , b.customer_name, a.price
order by a.invoice_id;</p>
<pre><code>


12. Activity Participants &lt;br&gt;
https://leetcode.com/problems/activity-participants/ &lt;br&gt; 

Table: Friends &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| id            | int     |
| name          | varchar |
| activity      | varchar |


id is the id of the friend and primary key for this table.&lt;br&gt;
name is the name of the friend.&lt;br&gt;
activity is the name of the activity which the friend takes part in.&lt;br&gt;

Table: Activities &lt;br&gt;

| Column Name   | Type    |
|---------------|---------|
| id            | int     |
| name          | varchar |

id is the primary key for this table.&lt;br&gt;
name is the name of the activity.&lt;br&gt;

Write an SQL query to find the names of all the activities with neither maximum, nor minimum number of participants.&lt;br&gt;

Return the result table in any order. Each activity in table Activities is performed by any person in the table Friends.&lt;br&gt;

The query result format is in the following example:&lt;br&gt;

</code></pre>
<p>Friends table:
+------+--------------+---------------+
| id   | name         | activity      |
+------+--------------+---------------+
| 1    | Jonathan D.  | Eating        |
| 2    | Jade W.      | Singing       |
| 3    | Victor J.    | Singing       |
| 4    | Elvis Q.     | Eating        |
| 5    | Daniel A.    | Eating        |
| 6    | Bob B.       | Horse Riding  |
+------+--------------+---------------+</p>
<p>Activities table:
+------+--------------+
| id   | name         |
+------+--------------+
| 1    | Eating       |
| 2    | Singing      |
| 3    | Horse Riding |
+------+--------------+</p>
<p>Result table:
+--------------+
| activity     |
+--------------+
| Singing      |
+--------------+</p>
<p>Eating activity is performed by 3 friends, maximum number of participants, (Jonathan D. , Elvis Q. and Daniel A.)
Horse Riding activity is performed by 1 friend, minimum number of participants, (Bob B.)
Singing is performed by 2 friends (Victor J. and Jade W.)</p>
<pre><code>
Ans.

</code></pre>
<p>select activity from (
                select
                    activity,
                    count(<em>) as act_count,
                    min(count(</em>)) over () as min_cnt,
                    max(count(*)) over () as max_cnt
                from friends
                group by activity
                order by activity
                    ) 
where min_cnt&lt;act_count and act_count&lt;max_cnt;</p>
<pre><code>

13. Second Degree Follower &lt;br&gt;
https://leetcode.com/problems/second-degree-follower/submissions/ &lt;br&gt;

In facebook, there is a follow table with two columns: followee, follower. &lt;br&gt;

Please write a sql query to get the amount of each follower’s follower if he/she has one. &lt;br&gt;

For example: &lt;br&gt;

| followee    | follower   |
|-------------|------------|
|     A       |     B      |
|     B       |     C      |
|     B       |     D      |
|     D       |     E      |


should output:

| follower    | num        |
|-------------|------------|
|     B       |  2         |
|     D       |  1         |


Explaination: &lt;br&gt;
Both B and D exist in the follower list, when as a followee, B's follower is C and D, and D's follower is E. &lt;br&gt;
A does not exist in follower list. &lt;br&gt;

Note: &lt;br&gt;
Followee would not follow himself/herself in all cases. &lt;br&gt;

Ans. &lt;br&gt;
There could be duplicates in table, so use count distinct for counting followers. &lt;br&gt;

</code></pre>
<p>select 
    main as follower, 
    count(distinct follower) as num 
from (
    select 
        a.follower as main,
        b.follower    as follower
    from follow a inner join follow b
    on a.follower = b.followee
    )
group by main 
order by main;
```</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../sql-analytical-functions/" class="md-footer__link md-footer__link--prev" aria-label="Previous: SQL Analytical Functions" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              SQL Analytical Functions
            </div>
          </div>
        </a>
      
      
        
        <a href="../Data-Warehousing-basics/" class="md-footer__link md-footer__link--next" aria-label="Next: Data Warehousing Concepts" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Data Warehousing Concepts
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Kushal Luthra
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/kushal-luthra" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/kushal_luthra" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://www.linkedin.com/in/kushalluthra/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
    
  </body>
</html>